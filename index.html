<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Rating - FIDE / CBX / FPBX</title>
  <style>
    :root {
      --azul: #002f6c;
      --fundo: #f4f6fa;
      --verde: #28a745;
      --vermelho: #dc3545;
      --cinza: #6c757d;
      --texto: #111;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: var(--fundo);
      color: var(--texto);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-size: 16px;
      line-height: 1.4;
    }
    header {
      background: var(--azul);
      color: #fff;
      padding: 14px;
      text-align: center;
      font-size: 24px;
      font-weight: 700;
    }
    .container {
      flex: 1;
      max-width: 900px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
    }
    .campo {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }
    .campo label {
      font-weight: bold;
      min-width: 130px;
    }
    input[type="number"], select {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 16px;
    }
    th {
      background: var(--azul);
      color: #fff;
    }
    .adv { width: 70px; }
    .resultado {
      display: flex;
      justify-content: center;
      gap: 4px;
    }
    .resultado input[type="radio"] { display: none; }
    .resultado label {
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      min-width: 28px;
      transition: all 0.2s;
      font-weight: bold;
    }
    .resultado input:disabled + label {
      background: #eee !important;
      color: #999 !important;
      cursor: not-allowed;
    }
    .v label { background: #e8f5e8; color: var(--verde); }
    .e label { background: #f0f0f0; color: #555; }
    .d label { background: #ffe6e6; color: var(--vermelho); }
    .v input:checked + label { background: var(--verde); color: #fff; }
    .e input:checked + label { background: var(--cinza); color: #fff; }
    .d input:checked + label { background: var(--vermelho); color: #fff; }
    .delta.pos { color: var(--verde); font-weight: bold; }
    .delta.neg { color: var(--vermelho); font-weight: bold; }
    .delta.zero { color: #000; }
    .final.pos { color: var(--verde); font-weight: bold; }
    .final.neg { color: var(--vermelho); font-weight: bold; }
    .final.zero { color: #000; }
    #totais { font-weight: bold; background: #f9f9f9; }
    #kManualContainer { display: none; }
    @media (max-width: 600px) {
      .campo { flex-direction: column; align-items: flex-start; }
      input[type="number"], select { width: 100%; }
      table { font-size: 14px; }
      .adv { width: 60px; }
      .resultado label { padding: 4px 6px; font-size: 11px; }
    }
  </style>
</head>
<body>
  <header>Calculadora de Rating</header>
  <div class="container">
    <div class="campo">
      <label for="ratingInicial">Rating Inicial:</label>
      <input type="number" id="ratingInicial" value="1944" min="0" />
    </div>

    <div class="campo">
      <label>Tipo de Rating:</label>
      <label><input type="radio" name="tipoRating" value="fide" checked> FIDE</label>
      <label><input type="radio" name="tipoRating" value="cbx"> CBX</label>
      <label><input type="radio" name="tipoRating" value="fpbx"> FPBX</label>
    </div>

    <div class="campo" id="kManualContainer">
      <label for="kManual">K (CBX):</label>
      <select id="kManual">
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20" selected>20</option>
        <option value="25">25</option>
        <option value="40">40</option>
      </select>
    </div>

    <table id="tabela">
      <thead>
        <tr>
          <th>Rodada</th>
          <th>Rtg. Adv.</th>
          <th>Resultado</th>
          <th>Δ</th>
          <th>Rtg. Final</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr id="totais">
          <td colspan="2"><strong>Totais</strong></td>
          <td class="pontos"></td>
          <td class="variacao-total"></td>
          <td class="rtg-final"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <script>
    const ROUNDS = 11;
    const tbody = document.querySelector('#tabela tbody');

    for (let i = 1; i <= ROUNDS; i++) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i}</td>
        <td><input type="number" class="adv" min="0" step="1" /></td>
        <td class="resultado">
          <span class="v"><input type="radio" name="res${i}" value="v" id="v${i}" disabled><label for="v${i}">V</label></span>
          <span class="e"><input type="radio" name="res${i}" value="e" id="e${i}" disabled><label for="e${i}">E</label></span>
          <span class="d"><input type="radio" name="res${i}" value="d" id="d${i}" disabled><label for="d${i}">D</label></span>
        </td>
        <td class="delta">-</td>
        <td class="final"></td>
      `;
      tbody.appendChild(tr);
    }

    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

    // FÓRMULA OFICIAL ELO
    function getExpected(ratingA, ratingB) {
      const dr = ratingA - ratingB;
      return 1 / (1 + Math.pow(10, -dr / 400));
    }

    function kFide(r) { return r < 2400 ? 20 : 10; }

    document.querySelectorAll('input[name="tipoRating"]').forEach(r => {
      r.addEventListener('change', () => {
        document.getElementById('kManualContainer').style.display = r.value === 'cbx' ? 'flex' : 'none';
        calcular();
      });
    });

    function updateButtons() {
      tbody.querySelectorAll('tr').forEach(tr => {
        const adv = tr.querySelector('.adv').value.trim();
        const radios = tr.querySelectorAll('.resultado input[type=radio]');
        const valid = adv !== '' && Number(adv) > 0;
        radios.forEach(r => r.disabled = !valid);
      });
    }

    function calcular() {
      const tipo = document.querySelector('input[name="tipoRating"]:checked').value;
      const ratingBase = Number(document.getElementById('ratingInicial').value) || 0;
      const K = tipo === 'fide' ? kFide(ratingBase) : (tipo === 'fpbx' ? 20 : Number(document.getElementById('kManual').value));

      let somaDelta = 0;
      let totalPts = 0;

      const rows = Array.from(tbody.querySelectorAll('tr'));

      rows.forEach(tr => {
        const advRaw = tr.querySelector('.adv').value.trim();
        const adv = advRaw === '' ? 0 : Number(advRaw);
        const radio = tr.querySelector('input[type=radio]:checked');
        const tdDelta = tr.querySelector('.delta');
        const tdFinal = tr.querySelector('.final');

        if (!radio || adv <= 0) {
          tdDelta.textContent = '-';
          tdFinal.textContent = '';
          return;
        }

        const S = radio.value === 'v' ? 1 : (radio.value === 'e' ? 0.5 : 0);
        const ignore = (tipo === 'cbx' || tipo === 'fpbx') && adv <= 0;

        let delta = 0;
        if (!ignore && adv > 0) {
          const E = getExpected(ratingBase, adv);  // E = probabilidade de VOCÊ ganhar
          const deltaRaw = K * (S - E);
          delta = tipo === 'cbx' ? Math.round(deltaRaw) : deltaRaw.toFixed(2);
        }

        somaDelta += (tipo === 'cbx' ? delta : parseFloat(delta));
        const ratingAtual = ratingBase + somaDelta;

        tdDelta.textContent = delta === 0 ? '0' : (delta > 0 ? '+' : '') + delta;
        tdDelta.className = 'delta ' + (delta > 0 ? 'pos' : (delta < 0 ? 'neg' : 'zero'));
        tdFinal.textContent = Math.round(ratingAtual);
        tdFinal.className = 'final ' + (ratingAtual > ratingBase ? 'pos' : (ratingAtual < ratingBase ? 'neg' : 'zero'));

        if (!ignore) totalPts += S;
      });

      const totais = document.querySelector('#totais');
      const variacao = Math.round(somaDelta);
      totais.innerHTML = `
        <td colspan="2"><strong>Totais</strong></td>
        <td class="pontos">${totalPts}</td>
        <td class="variacao-total ${variacao > 0 ? 'pos' : (variacao < 0 ? 'neg' : 'zero')}">${variacao > 0 ? '+' : ''}${variacao}</td>
        <td class="rtg-final ${variacao > 0 ? 'pos' : (variacao < 0 ? 'neg' : 'zero')}">${Math.round(ratingBase + variacao)}</td>
      `;
    }

    document.getElementById('ratingInicial').addEventListener('input', calcular);
    document.getElementById('kManual').addEventListener('change', calcular);
    tbody.addEventListener('input', () => { updateButtons(); calcular(); });
    tbody.addEventListener('change', calcular);

    updateButtons();
    calcular();
  </script>
</body>
</html>
