<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Rating - FIDE / CBX / FPBX</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; color: #333; }
    h1 { text-align: center; color: #2c3e50; }
    .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .campo { margin: 15px 0; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
    .campo label { font-weight: bold; min-width: 120px; }
    input[type="number"], select { padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; width: 100px; }
    button { padding: 10px 20px; font-size: 16px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #2980b9; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f2f2f2; }
    .adv { width: 60px; }
    .resultado { display: flex; justify-content: center; gap: 5px; }
    .delta, .final { font-weight: bold; }
    .pos { color: green; }
    .neg { color: red; }
    .zero { color: #777; }
    #totais { font-weight: bold; background: #f9f9f9; }
    #kManualContainer { margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Calculadora de Rating</h1>
    <p style="text-align:center;">FIDE • CBX • FPBX</p>

    <form>
      <div class="campo">
        <label for="ratingInicial">Rating Inicial:</label>
        <input type="number" id="ratingInicial" value="1861" min="0" step="1" />
      </div>

      <div class="campo">
        <label>Tipo de Rating:</label>
        <label><input type="radio" name="tipoRating" value="fide" checked> FIDE</label>
        <label><input type="radio" name="tipoRating" value="cbx"> CBX</label>
        <label><input type="radio" name="tipoRating" value="fpbx"> FPBX</label>
      </div>

      <div class="campo" id="kManualContainer" style="display: none;">
        <label for="kManual">K (CBX):</label>
        <select id="kManual">
          <option value="10">10</option>
          <option value="15">15</option>
          <option value="20" selected>20</option>
          <option value="25">25</option>
          <option value="40">40</option>
        </select>
      </div>

      <div class="campo">
        <button type="button" onclick="calcular()">Calcular</button>
      </div>
    </form>

    <table id="tabela">
      <thead>
        <tr>
          <th>Rodada</th>
          <th>Rtg. Adv.</th>
          <th>Resultado</th>
          <th>Δ</th>
          <th>Rtg. Final</th>
        </tr>
      </thead>
      <tbody>
        <!-- 11 linhas automáticas -->
      </tbody>
      <tfoot>
        <tr id="totais">
          <td colspan="2"><strong>Totais</strong></td>
          <td class="pontos"></td>
          <td class="variacao-total"></td>
          <td class="rtg-final"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <script>
    // --- CONFIGURAÇÃO ---
    const ROUNDS = 11;
    const tbody = document.querySelector('#tabela tbody');

    // Criar linhas
    for (let i = 1; i <= ROUNDS; i++) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i}</td>
        <td><input type="number" class="adv" min="0" step="1" /></td>
        <td class="resultado">
          <label><input type="radio" name="res${i}" value="v" disabled> V</label>
          <label><input type="radio" name="res${i}" value="e" disabled> E</label>
          <label><input type="radio" name="res${i}" value="d" disabled> D</label>
        </td>
        <td class="delta">-</td>
        <td class="final"></td>
      `;
      tbody.appendChild(tr);
    }

    // utilitários
    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }
    function round2(v) { return Math.round((v + Number.EPSILON) * 100) / 100; }

    // Tabela FIDE 8.1b
    const fideTable = [
      {min: 0, max: 3, pd: 0.50}, {min: 4, max: 10, pd: 0.51}, {min: 11, max: 17, pd: 0.52},
      {min: 18, max: 25, pd: 0.53}, {min: 26, max: 32, pd: 0.54}, {min: 33, max: 39, pd: 0.55},
      {min: 40, max: 46, pd: 0.56}, {min: 47, max: 53, pd: 0.57}, {min: 54, max: 61, pd: 0.58},
      {min: 62, max: 68, pd: 0.59}, {min: 69, max: 76, pd: 0.60}, {min: 77, max: 83, pd: 0.61},
      {min: 84, max: 91, pd: 0.62}, {min: 92, max: 98, pd: 0.63}, {min: 99, max: 106, pd: 0.64},
      {min: 107, max: 113, pd: 0.65}, {min: 114, max: 121, pd: 0.66}, {min: 122, max: 129, pd: 0.67},
      {min: 130, max: 137, pd: 0.68}, {min: 138, max: 145, pd: 0.69}, {min: 146, max: 153, pd: 0.70},
      {min: 154, max: 162, pd: 0.71}, {min: 163, max: 170, pd: 0.72}, {min: 171, max: 179, pd: 0.73},
      {min: 180, max: 188, pd: 0.74}, {min: 189, max: 197, pd: 0.75}, {min: 198, max: 206, pd: 0.76},
      {min: 207, max: 215, pd: 0.77}, {min: 216, max: 225, pd: 0.78}, {min: 226, max: 235, pd: 0.79},
      {min: 236, max: 245, pd: 0.80}, {min: 246, max: 256, pd: 0.81}, {min: 257, max: 267, pd: 0.82},
      {min: 268, max: 278, pd: 0.83}, {min: 279, max: 290, pd: 0.84}, {min: 291, max: 302, pd: 0.85},
      {min: 303, max: 315, pd: 0.86}, {min: 316, max: 328, pd: 0.87}, {min: 329, max: 344, pd: 0.88},
      {min: 345, max: 357, pd: 0.89}, {min: 358, max: 374, pd: 0.90}, {min: 375, max: 391, pd: 0.91},
      {min: 392, max: 411, pd: 0.92}, {min: 412, max: 432, pd: 0.93}, {min: 433, max: 456, pd: 0.94},
      {min: 457, max: 484, pd: 0.95}, {min: 485, max: 517, pd: 0.96}, {min: 518, max: 559, pd: 0.97},
      {min: 560, max: 619, pd: 0.98}, {min: 620, max: 735, pd: 0.99}, {min: 736, max: Infinity, pd: 1.00}
    ];

    function getPdFromTable(diff) {
      for (let entry of fideTable) {
        if (diff >= entry.min && diff <= entry.max) return entry.pd;
      }
      return 1.00;
    }

    // Função para obter E
    function getExpected(dr, tipo) {
      if (tipo === 'fide' || tipo === 'fpbx') {
        const diff = Math.abs(dr);
        const pdHigher = getPdFromTable(diff);
        if (dr > 0) return 1 - pdHigher;
        if (dr < 0) return pdHigher;
        return 0.5;
      }
      return 1 / (1 + Math.pow(10, -dr / 400));
    }

    // K automático (FIDE)
    function kFide(ratingBase) {
      return ratingBase < 2400 ? 20 : 10;
    }

    // Mostrar K manual apenas para CBX
    document.querySelectorAll('input[name="tipoRating"]').forEach(radio => {
      radio.addEventListener('change', () => {
        document.getElementById('kManualContainer').style.display = radio.value === 'cbx' ? 'block' : 'none';
      });
    });

    // Habilitar botões de resultado
    function updateResultButtons() {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.forEach((tr) => {
        const advInput = tr.querySelector('.adv');
        const radioButtons = tr.querySelectorAll('.resultado input[type=radio]');
        const advValue = advInput.value.trim();
        const isValidRating = advValue !== '' && Number(advValue) > 0;
        radioButtons.forEach(radio => {
          radio.disabled = !isValidRating;
        });
      });
    }

    // Atualizar botões ao digitar
    tbody.addEventListener('input', updateResultButtons);
    tbody.addEventListener('change', updateResultButtons);

    // Cálculo central
    function calcular() {
      const tipo = document.querySelector('input[name="tipoRating"]:checked').value;
      const ratingBase = Number(document.getElementById('ratingInicial').value) || 0;

      let K;
      if (tipo === 'fide') K = kFide(ratingBase);
      else if (tipo === 'fpbx') K = 20;
      else K = Number(document.getElementById('kManual').value);

      let somaDelta = 0;
      let totalPts = 0;
      let jogos = 0;
      let sumRated = 0;
      let countRated = 0;

      const rows = Array.from(tbody.querySelectorAll('tr'));

      // Primeiro pass: rated opponents
      rows.forEach((tr) => {
        const advRaw = tr.querySelector('.adv').value.trim();
        const adv = advRaw === '' ? 0 : Number(advRaw);
        const radioSel = tr.querySelector('input[type=radio]:checked');
        if (radioSel && adv > 0) {
          sumRated += adv;
          countRated++;
        }
      });
      const avgRated = countRated > 0 ? sumRated / countRated : ratingBase;

      // Segundo pass: calcular
      rows.forEach((tr) => {
        const advInput = tr.querySelector('.adv');
        const advRaw = advInput.value.trim();
        const adv = advRaw === '' ? 0 : Number(advRaw);
        const radioSel = tr.querySelector('input[type=radio]:checked');
        const tdDelta = tr.querySelector('.delta');
        const tdFinal = tr.querySelector('.final');

        if (adv === 0 && !radioSel) {
          tdDelta.textContent = '-';
          tdFinal.textContent = '';
          return;
        }
        if (!radioSel) {
          tdDelta.textContent = '-';
          tdFinal.textContent = Math.round(ratingBase + somaDelta);
          return;
        }

        const S = radioSel.value === 'v' ? 1 : (radioSel.value === 'e' ? 0.5 : 0);
        let delta = 0;

        const isUnrated = adv <= 0;
        const ignoreUnrated = (tipo === 'cbx' || tipo === 'fpbx') && isUnrated;

        if (!ignoreUnrated && adv > 0) {
          let dr = adv - ratingBase;
          dr = clamp(dr, -800, 800);
          const E = getExpected(dr, tipo);
          const deltaRaw = K * (S - E);
          delta = tipo === 'cbx' ? Math.round(deltaRaw) : round2(deltaRaw);
        }

        somaDelta = tipo === 'cbx' ? somaDelta + delta : round2(somaDelta + delta);
        const ratingAgora = ratingBase + somaDelta;

        tdDelta.textContent = delta === 0 ? '0' : (delta > 0 ? '+' : '') + (tipo === 'cbx' ? delta : delta.toFixed(2));
        tdDelta.className = 'delta ' + (delta > 0 ? 'pos' : (delta < 0 ? 'neg' : 'zero'));
        tdFinal.textContent = Math.round(ratingAgora);
        tdFinal.className = 'final ' + (ratingAgora > ratingBase ? 'pos' : (ratingAgora < ratingBase ? 'neg' : 'zero'));

        if (!ignoreUnrated) {
          jogos++;
          totalPts += S;
        }
      });

      const totaisRow = document.querySelector('#totais');
      const variacaoTotal = tipo === 'cbx' ? Math.round(somaDelta) : round2(somaDelta);
      totaisRow.innerHTML = `
        <td colspan="2"><strong>Totais</strong></td>
        <td class="pontos">${totalPts}</td>
        <td class="variacao-total ${variacaoTotal > 0 ? 'pos' : (variacaoTotal < 0 ? 'neg' : 'zero')}">${variacaoTotal > 0 ? '+' : ''}${variacaoTotal}</td>
        <td class="rtg-final ${variacaoTotal > 0 ? 'pos' : (variacaoTotal < 0 ? 'neg' : 'zero')}">${Math.round(ratingBase + variacaoTotal)}</td>
      `;
    }

    // Inicializar
    updateResultButtons();
  </script>
</body>
</html>
