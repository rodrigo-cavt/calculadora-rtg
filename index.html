<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Rating - FIDE / CBX / FPBX</title>
  <style>
    :root {
      --azul: #002f6c;
      --fundo: #f4f6fa;
      --verde: #28a745;
      --vermelho: #dc3545;
      --cinza: #6c757d;
      --texto: #111;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, Helvetica, sans-serif;
      background: var(--fundo);
      color: var(--texto);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-size: 16px;
      line-height: 1.4;
    }
    header {
      background: var(--azul);
      color: #fff;
      padding: 14px;
      text-align: center;
      font-size: 24px;
      font-weight: 700;
    }
    .container {
      flex: 1;
      max-width: 900px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0,0,0,0.1);
    }
    .campo {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }
    .campo label {
      font-weight: bold;
      min-width: 130px;
    }
    input[type="number"], select {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 16px;
    }
    th {
      background: var(--azul);
      color: #fff;
    }
    .adv { width: 70px; }
    .resultado {
      display: flex;
      justify-content: center;
      gap: 4px;
    }
    .resultado input[type="radio"] { display: none; }
    .resultado label {
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      min-width: 28px;
      transition: all 0.2s;
      font-weight: bold;
    }
    .resultado input:disabled + label {
      background: #eee !important;
      color: #999 !important;
      cursor: not-allowed;
    }
    /* Cores padrão (não selecionado) */
    .v label { background: #e8f5e8; color: var(--verde); }
    .e label { background: #f0f0f0; color: #555; }
    .d label { background: #ffe6e6; color: var(--vermelho); }
    /* Cores quando selecionado */
    .v input:checked + label { background: var(--verde); color: #fff; }
    .e input:checked + label { background: var(--cinza); color: #fff; }
    .d input:checked + label { background: var(--vermelho); color: #fff; }

    .delta.pos { color: var(--verde); font-weight: bold; }
    .delta.neg { color: var(--vermelho); font-weight: bold; }
    .delta.zero { color: #000; }
    .final.pos { color: var(--verde); font-weight: bold; }
    .final.neg { color: var(--vermelho); font-weight: bold; }
    .final.zero { color: #000; }
    #totais {
      font-weight: bold;
      background: #f9f9f9;
    }
    #kManualContainer { display: none; }
    @media (max-width: 600px) {
      .campo { flex-direction: column; align-items: flex-start; }
      input[type="number"], select { width: 100%; }
      table { font-size: 14px; }
      .adv { width: 60px; }
      .resultado label { padding: 4px 6px; font-size: 11px; }
    }
  </style>
</head>
<body>
  <header>Calculadora de Rating</header>
  <div class="container">
    <div class="campo">
      <label for="ratingInicial">Rating Inicial:</label>
      <input type="number" id="ratingInicial" value="1944" min="0" />
    </div>

    <div class="campo">
      <label>Tipo de Rating:</label>
      <label><input type="radio" name="tipoRating" value="fide" checked> FIDE</label>
      <label><input type="radio" name="tipoRating" value="cbx"> CBX</label>
      <label><input type="radio" name="tipoRating" value="fpbx"> FPBX</label>
    </div>

    <div class="campo" id="kManualContainer">
      <label for="kManual">K (CBX):</label>
      <select id="kManual">
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20" selected>20</option>
        <option value="25">25</option>
        <option value="40">40</option>
      </select>
    </div>

    <table id="tabela">
      <thead>
        <tr>
          <th>Rodada</th>
          <th>Rtg. Adv.</th>
          <th>Resultado</th>
          <th>Δ</th>
          <th>Rtg. Final</th>
        </tr>
      </thead>
      <tbody>
        <!-- 11 linhas -->
      </tbody>
      <tfoot>
        <tr id="totais">
          <td colspan="2"><strong>Totais</strong></td>
          <td class="pontos"></td>
          <td class="variacao-total"></td>
          <td class="rtg-final"></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <script>
    const ROUNDS = 11;
    const tbody = document.querySelector('#tabela tbody');

    // Criar linhas
    for (let i = 1; i <= ROUNDS; i++) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i}</td>
        <td><input type="number" class="adv" min="0" step="1" /></td>
        <td class="resultado">
          <span class="v"><input type="radio" name="res${i}" value="v" disabled><label>V</label></span>
          <span class="e"><input type="radio" name="res${i}" value="e" disabled><label>E</label></span>
          <span class="d"><input type="radio" name="res${i}" value="d" disabled><label>D</label></span>
        </td>
        <td class="delta">-</td>
        <td class="final"></td>
      `;
      tbody.appendChild(tr);
    }

    function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }
    function round2(v) { return Math.round((v + Number.EPSILON) * 100) / 100; }

    const fideTable = [
      {min: 0, max: 3, pd: 0.50}, {min: 4, max: 10, pd: 0.51}, {min: 11, max: 17, pd: 0.52},
      {min: 18, max: 25, pd: 0.53}, {min: 26, max: 32, pd: 0.54}, {min: 33, max: 39, pd: 0.55},
      {min: 40, max: 46, pd: 0.56}, {min: 47, max: 53, pd: 0.57}, {min: 54, max: 61, pd: 0.58},
      {min: 62, max: 68, pd: 0.59}, {min: 69, max: 76, pd: 0.60}, {min: 77, max: 83, pd: 0.61},
      {min: 84, max: 91, pd: 0.62}, {min: 92, max: 98, pd: 0.63}, {min: 99, max: 106, pd: 0.64},
      {min: 107, max: 113, pd: 0.65}, {min: 114, max: 121, pd: 0.66}, {min: 122, max: 129, pd: 0.67},
      {min: 130, max: 137, pd: 0.68}, {min: 138, max: 145, pd: 0.69}, {min: 146, max: 153, pd: 0.70},
      {min: 154, max: 162, pd: 0.71}, {min: 163, max: 170, pd: 0.72}, {min: 171, max: 179, pd: 0.73},
      {min: 180, max: 188, pd: 0.74}, {min: 189, max: 197, pd: 0.75}, {min: 198, max: 206, pd: 0.76},
      {min: 207, max: 215, pd: 0.77}, {min: 216, max: 225, pd: 0.78}, {min: 226, max: 235, pd: 0.79},
      {min: 236, max: 245, pd: 0.80}, {min: 246, max: 256, pd: 0.81}, {min: 257, max: 267, pd: 0.82},
      {min: 268, max: 278, pd: 0.83}, {min: 279, max: 290, pd: 0.84}, {min: 291, max: 302, pd: 0.85},
      {min: 303, max: 315, pd: 0.86}, {min: 316, max: 328, pd: 0.87}, {min: 329, max: 344, pd: 0.88},
      {min: 345, max: 357, pd: 0.89}, {min: 358, max: 374, pd: 0.90}, {min: 375, max: 391, pd: 0.91},
      {min: 392, max: 411, pd: 0.92}, {min: 412, max: 432, pd: 0.93}, {min: 433, max: 456, pd: 0.94},
      {min: 457, max: 484, pd: 0.95}, {min: 485, max: 517, pd: 0.96}, {min: 518, max: 559, pd: 0.97},
      {min: 560, max: 619, pd: 0.98}, {min: 620, max: 735, pd: 0.99}, {min: 736, max: Infinity, pd: 1.00}
    ];

    function getPdFromTable(diff) {
      for (let e of fideTable) if (diff >= e.min && diff <= e.max) return e.pd;
      return 1.00;
    }

    function getExpected(dr, tipo) {
      if (tipo === 'fide' || tipo === 'fpbx') {
        const diff = Math.abs(dr);
        const pd = getPdFromTable(diff);
        return dr > 0 ? 1 - pd : (dr < 0 ? pd : 0.5);
      }
      return 1 / (1 + Math.pow(10, -dr / 400));
    }

    function kFide(r) { return r < 2400 ? 20 : 10; }

    // Mostrar K manual
    document.querySelectorAll('input[name="tipoRating"]').forEach(r => {
      r.addEventListener('change', () => {
        const show = r.value === 'cbx';
        document.getElementById('kManualContainer').style.display = show ? 'flex' : 'none';
        calcular();
      });
    });

    // Habilitar botões
    function updateButtons() {
      tbody.querySelectorAll('tr').forEach(tr => {
        const adv = tr.querySelector('.adv').value.trim();
        const radios = tr.querySelectorAll('.resultado input[type=radio]');
        const valid = adv !== '' && Number(adv) > 0;
        radios.forEach(r => r.disabled = !valid);
      });
    }

    // Cálculo em tempo real
    function calcular() {
      const tipo = document.querySelector('input[name="tipoRating"]:checked').value;
      const ratingBase = Number(document.getElementById('ratingInicial').value) || 0;
      const K = tipo === 'fide' ? kFide(ratingBase) : (tipo === 'fpbx' ? 20 : Number(document.getElementById('kManual').value));

      let somaDelta = 0;
      let totalPts = 0;
      let jogos = 0;

      const rows = Array.from(tbody.querySelectorAll('tr'));

      rows.forEach(tr => {
        const advRaw = tr.querySelector('.adv').value.trim();
        const adv = advRaw === '' ? 0 : Number(advRaw);
        const radio = tr.querySelector('input[type=radio]:checked');
        const tdDelta = tr.querySelector('.delta');
        const tdFinal = tr.querySelector('.final');

        if (!radio) {
          tdDelta.textContent = '-';
          tdFinal.textContent = '';
          return;
        }

        const S = radio.value === 'v' ? 1 : (radio.value === 'e' ? 0.5 : 0);
        let delta = 0;
        const isUnrated = adv <= 0;
        const ignore = (tipo === 'cbx' || tipo === 'fpbx') && isUnrated;

        if (!ignore && adv > 0) {
          let dr = adv - ratingBase;  // CORRETO: dr = adversário - seu rating
          dr = clamp(dr, -800, 800);
          const E = getExpected(dr, tipo);
          const deltaRaw = K * (S - E);
          delta = tipo === 'cbx' ? Math.round(deltaRaw) : round2(deltaRaw);
        }

        somaDelta = tipo === 'cbx' ? somaDelta + delta : round2(somaDelta + delta);
        const ratingAtual = ratingBase + somaDelta;

        tdDelta.textContent = delta === 0 ? '0' : (delta > 0 ? '+' : '') + (tipo === 'cbx' ? delta : delta.toFixed(2));
        tdDelta.className = 'delta ' + (delta > 0 ? 'pos' : (delta < 0 ? 'neg' : 'zero'));
        tdFinal.textContent = Math.round(ratingAtual);
        tdFinal.className = 'final ' + (ratingAtual > ratingBase ? 'pos' : (ratingAtual < ratingBase ? 'neg' : 'zero'));

        if (!ignore) {
          jogos++;
          totalPts += S;
        }
      });

      const totais = document.querySelector('#totais');
      const variacao = tipo === 'cbx' ? Math.round(somaDelta) : round2(somaDelta);
      totais.innerHTML = `
        <td colspan="2"><strong>Totais</strong></td>
        <td class="pontos">${totalPts}</td>
        <td class="variacao-total ${variacao > 0 ? 'pos' : (variacao < 0 ? 'neg' : 'zero')}">${variacao > 0 ? '+' : ''}${variacao}</td>
        <td class="rtg-final ${variacao > 0 ? 'pos' : (variacao < 0 ? 'neg' : 'zero')}">${Math.round(ratingBase + variacao)}</td>
      `;
    }

    // Eventos em tempo real
    document.getElementById('ratingInicial').addEventListener('input', calcular);
    document.getElementById('kManual').addEventListener('change', calcular);
    tbody.addEventListener('input', () => { updateButtons(); calcular(); });
    tbody.addEventListener('change', () => { updateButtons(); calcular(); });

    // Inicializar
    updateButtons();
    calcular();
  </script>
</body>
</html>
